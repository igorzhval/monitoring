<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–û–±–ª—ñ–∫ –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—ó</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- SheetJS –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary: #2e86de;
      --background: #f1f2f6;
      --card: #ffffffcc;
      --accent: #dcdde1;
      --text: #2f3640;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(to bottom right, #dff9fb, #f6e58d);
      color: var(--text);
      min-height: 100vh;
    }

    header {
      background-color: var(--primary);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    header h1 {
      margin: 0;
      font-size: 28px;
    }

    nav {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    nav button {
      background: white;
      color: var(--primary);
      border: 2px solid var(--primary);
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.2s;
    }

    nav button.active,
    nav button:hover {
      background: var(--primary);
      color: white;
    }

    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 10px;
    }

    .card {
      background-color: var(--card);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      backdrop-filter: blur(5px);
    }

    select,
    input {
      padding: 10px;
      width: 100%;
      max-width: 300px;
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 15px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .btn {
      padding: 10px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
      font-size: 16px;
      transition: background 0.2s;
    }

    .btn:hover {
      background-color: #1b4f9c;
    }

    #report-output {
      background: var(--accent);
      padding: 15px;
      border-radius: 6px;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    .hidden {
      display: none;
    }

    ul {
      padding-left: 20px;
    }

    li {
      margin-bottom: 5px;
    }

    li button {
      margin-left: 5px;
      font-size: 14px;
      padding: 2px 6px;
      border-radius: 4px;
    }

    @media (max-width: 600px) {
      nav {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>–û–±–ª—ñ–∫ –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—ó</h1>
  <p>–ë—É–¥–∏–Ω–æ–∫: –ø—Ä–æ–≤. –≥–µ–Ω–µ—Ä–∞–ª–∞ –í–∏—à–Ω–µ–≤—Å—å–∫–æ–≥–æ 13/1</p>
  <nav>
    <button onclick="showSection('flats')" id="btn-flats" class="active">–ö–≤–∞—Ä—Ç–∏—Ä–∏</button>
    <button onclick="showSection('report')" id="btn-report">–ó–≤—ñ—Ç</button>
  </nav>
</header>

<div class="container">
  <!-- –ö–≤–∞—Ä—Ç–∏—Ä–∏ -->
  <div class="card" id="section-flats">
    <h2>–í–∏–±—ñ—Ä –∫–≤–∞—Ä—Ç–∏—Ä–∏</h2>
    <select id="flat-select" onchange="showFlatForm()">
      <option value="">‚Äî –í–∏–±–µ—Ä—ñ—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É ‚Äî</option>
    </select>

    <div id="flat-form" class="form-group hidden">
      <label for="flat-month">–ú—ñ—Å—è—Ü—å</label>
      <input type="month" id="flat-month" />

      <label for="flat-value">–°–ø–æ–∂–∏–≤–∞–Ω–Ω—è (–∫–í—Ç¬∑–≥)</label>
      <input type="number" id="flat-value" placeholder="0" />

      <button class="btn" onclick="saveConsumption()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>

      <hr />
      <h3>–í–Ω–µ—Å–µ–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏:</h3>
      <div id="existing-data"></div>
    </div>
  </div>

  <!-- –ó–≤—ñ—Ç -->
  <div class="card hidden" id="section-report">
    <h2>–ó–≤—ñ—Ç –∑–∞ –ø–µ—Ä—ñ–æ–¥</h2>
    <div class="form-group">
      <label>–ó:</label>
      <input type="month" id="from" />
      <label>–î–æ:</label>
      <input type="month" id="to" />
      <button class="btn" onclick="generateReport()">üìä –ü–æ–∫–∞–∑–∞—Ç–∏ –∑–≤—ñ—Ç</button>
      <button class="btn" onclick="exportToExcel()">üì• –ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —É Excel</button>
    </div>
    <div id="report-output"></div>
  </div>
</div>

<!-- Firebase —Ç–∞ –æ—Å–Ω–æ–≤–Ω–∏–π –∫–æ–¥ -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBNoc5gDs5oiKMM2vfi9SLV0V81YIQlhIw",
    authDomain: "electricitymonitoring-611d6.firebaseapp.com",
    projectId: "electricitymonitoring-611d6",
    storageBucket: "electricitymonitoring-611d6.firebasestorage.app",
    messagingSenderId: "48991179626",
    appId: "1:48991179626:web:15bd1512333f0cd2258b13",
    measurementId: "G-380QK2FKVP"
  };

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const STORAGE_KEY = 'electricity_data';
  let flats = [];

  function initData() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      flats = JSON.parse(saved);
    } else {
      flats = Array.from({ length: 300 }, (_, i) => ({
        number: i + 1,
        consumption: {}
      }));
      saveData();
    }

    const select = document.getElementById('flat-select');
    flats.forEach(flat => {
      const opt = document.createElement('option');
      opt.value = flat.number;
      opt.textContent = `–ö–≤–∞—Ä—Ç–∏—Ä–∞ ‚Ññ${flat.number}`;
      select.appendChild(opt);
    });
  }

  function saveData() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(flats));
  }

  async function saveFlatToFirebase(flat) {
    try {
      await setDoc(doc(db, "flats", flat.number.toString()), {
        consumption: flat.consumption
      });
      console.log(`–î–∞–Ω—ñ –∫–≤–∞—Ä—Ç–∏—Ä–∏ ‚Ññ${flat.number} —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ —É Firebase`);
    } catch (e) {
      console.error("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —É Firebase: ", e);
    }
  }

  async function saveConsumption() {
    const flatNum = parseInt(document.getElementById('flat-select').value);
    const month = document.getElementById('flat-month').value;
    const value = parseFloat(document.getElementById('flat-value').value);
    if (!flatNum || !month || isNaN(value)) {
      alert("‚ùó –ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è.");
      return;
    }
    const flat = flats.find(f => f.number === flatNum);
    flat.consumption[month] = value;
    saveData(); // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ª–æ–∫–∞–ª—å–Ω–æ

    await saveFlatToFirebase(flat); // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —É Firebase

    alert(`‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ: –∫–≤. ‚Ññ${flatNum}, ${month} ‚Äî ${value} –∫–í—Ç¬∑–≥`);
    document.getElementById('flat-month').value = '';
    document.getElementById('flat-value').value = '';
    showFlatForm();
  }

  function showFlatForm() {
    const select = document.getElementById('flat-select');
    const flatNum = parseInt(select.value);
    const form = document.getElementById('flat-form');
    const existingDataDiv = document.getElementById('existing-data');
    existingDataDiv.innerHTML = '';
    if (!flatNum) {
      form.classList.add('hidden');
      return;
    }
    form.classList.remove('hidden');
    const flat = flats.find(f => f.number === flatNum);

    if (flat && flat.consumption) {
      const entries = Object.entries(flat.consumption)
        .sort((a, b) => a[0].localeCompare(b[0]));

      if (entries.length === 0) {
        existingDataDiv.textContent = "–ü–æ–∫–∞–∑–Ω–∏–∫–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ.";
      } else {
        const ul = document.createElement('ul');
        entries.forEach(([month, val]) => {
          const li = document.createElement('li');
          const date = new Date(month + '-01');
          const monthName = date.toLocaleString('uk-UA', { month: 'long', year: 'numeric' });
          li.textContent = `${monthName}: ${val} –∫–í—Ç¬∑–≥`;
          ul.appendChild(li);
        });
        existingDataDiv.appendChild(ul);
      }
    }
  }

  function showSection(section) {
    document.getElementById('section-flats').classList.toggle('hidden', section !== 'flats');
    document.getElementById('section-report').classList.toggle('hidden', section !== 'report');

    document.getElementById('btn-flats').classList.toggle('active', section === 'flats');
    document.getElementById('btn-report').classList.toggle('active', section === 'report');
  }

  function generateReport() {
    const from = document.getElementById('from').value;
    const to = document.getElementById('to').value;
    const reportOutput = document.getElementById('report-output');
    reportOutput.textContent = '';

    if (!from || !to) {
      alert('‚ùó –í–∫–∞–∂—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥ –∑ —Ç–∞ –ø–æ');
      return;
    }
    if (from > to) {
      alert('‚ùó –î–∞—Ç–∞ "–∑" –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ —Ä–∞–Ω—ñ—à–µ –∞–±–æ –¥–æ—Ä—ñ–≤–Ω—é–≤–∞—Ç–∏ "–¥–æ"');
      return;
    }

    // –û–±—á–∏—Å–ª—é—î–º–æ –º—ñ—Å—è—Ü—ñ —É –ø–µ—Ä—ñ–æ–¥—ñ
    const monthsInRange = [];
    let current = new Date(from + '-01');
    const end = new Date(to + '-01');
    while (current <= end) {
      const m = current.toISOString().slice(0, 7);
      monthsInRange.push(m);
      current.setMonth(current.getMonth() + 1);
    }

    // –ó–±–∏—Ä–∞—î–º–æ –¥–∞–Ω—ñ
    let totalSum = 0;
    let totalMonths = 0;
    let totalFlats = flats.length;

    let reportText = `–ó–≤—ñ—Ç –∑–∞ –ø–µ—Ä—ñ–æ–¥: ${from} ‚Äì ${to}\n\n`;

    flats.forEach(flat => {
      let flatSum = 0;
      let monthsCount = 0;
      monthsInRange.forEach(m => {
        if (flat.consumption[m] !== undefined) {
          flatSum += flat.consumption[m];
          monthsCount++;
        }
      });
      if (monthsCount > 0) {
        reportText += `–ö–≤–∞—Ä—Ç–∏—Ä–∞ ‚Ññ${flat.number}: ${flatSum.toFixed(2)} –∫–í—Ç¬∑–≥ (${monthsCount} –º—ñ—Å.)\n`;
        totalSum += flatSum;
        totalMonths += monthsCount;
      }
    });

    reportText += `\n–í—Å—å–æ–≥–æ –ø–æ –±—É–¥–∏–Ω–∫—É: ${totalSum.toFixed(2)} –∫–í—Ç¬∑–≥`;

    reportOutput.textContent = reportText;
  }

  function exportToExcel() {
    const from = document.getElementById('from').value;
    const to = document.getElementById('to').value;
    if (!from || !to) {
      alert('‚ùó –í–∫–∞–∂—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥ –∑ —Ç–∞ –ø–æ');
      return;
    }
    if (from > to) {
      alert('‚ùó –î–∞—Ç–∞ "–∑" –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ —Ä–∞–Ω—ñ—à–µ –∞–±–æ –¥–æ—Ä—ñ–≤–Ω—é–≤–∞—Ç–∏ "–¥–æ"');
      return;
    }

    // –°—Ç–≤–æ—Ä—é—î–º–æ —Å–ø–∏—Å–æ–∫ –º—ñ—Å—è—Ü—ñ–≤ —É –¥—ñ–∞–ø–∞–∑–æ–Ω—ñ
    const months = [];
    let current = new Date(from + '-01');
    const end = new Date(to + '-01');
    while (current <= end) {
      months.push(current.toISOString().slice(0, 7));
      current.setMonth(current.getMonth() + 1);
    }

    // –§–æ—Ä–º—É—î–º–æ —Ç–∞–±–ª–∏—Ü—é –¥–ª—è SheetJS
    const ws_data = [
      ['–ö–≤–∞—Ä—Ç–∏—Ä–∞', ...months]
    ];

    flats.forEach(flat => {
      const row = [flat.number];
      months.forEach(m => {
        row.push(flat.consumption[m] ?? 0);
      });
      ws_data.push(row);
    });

    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "–ó–≤—ñ—Ç");
    XLSX.writeFile(wb, `electricity_report_${from}_to_${to}.xlsx`);
  }

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
  window.onload = () => {
    initData();
  };

  // –ó—Ä–æ–±–∏—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–æ—Å—Ç—É–ø–Ω–∏–º–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è onclick
  window.showSection = showSection;
  window.showFlatForm = showFlatForm;
  window.saveConsumption = saveConsumption;
  window.generateReport = generateReport;
  window.exportToExcel = exportToExcel;
</script>
</body>
</html>
